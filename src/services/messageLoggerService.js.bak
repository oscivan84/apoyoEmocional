// src/services/messageLoggerService.js
const { Pool } = require('pg');
const dbConfig = require('../config/db');
const MessageUtil = require('../utils/messageUtil');

const pool = new Pool(dbConfig);

async function logIncomingMessage({ from, message, flowState, context = null }) {
    try {
        let messageContent = message;
        let messageType = 'text';
        let metadata = {};

        // Procesar el mensaje si tenemos contexto
        if (context) {
            const processed = await MessageUtil.processMessage(context);
            messageContent = processed.content;
            messageType = processed.type;
            metadata = processed.metadata;
        }

        const result = await pool.query(
            `INSERT INTO mensajes_entrantes 
             (telefono, mensaje, estado_flujo, tipo_mensaje, metadata, fecha) 
             VALUES ($1, $2, $3, $4, $5, NOW())
             RETURNING id`,
            [from, messageContent, flowState || null, messageType, JSON.stringify(metadata)]
        );

        console.log(`✅ Mensaje registrado con ID: ${result.rows[0].id}`);
        return result.rows[0];
    } catch (error) {
        console.error('❌ Error al guardar el mensaje en PostgreSQL:', error);
        throw error;
    }
}

module.exports = {
    logIncomingMessage,
};
