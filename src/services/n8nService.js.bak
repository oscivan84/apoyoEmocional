// src/services/n8nService.js
const axios = require('axios');
const MessageUtil = require('../utils/messageUtil');

class N8NService {
    constructor() {
        this.webhookUrl = 'http://localhost:5678/webhook-test/whatsapp';
    }

    async sendToN8N(from, message, originalContext = null) {
        console.log('\n🔄 [N8N] Preparando envío:', { from, message });

        let processedMessage = message;
        let messageType = 'text';
        let metadata = {};

        // Procesar el mensaje si tenemos el contexto original
        if (originalContext) {
            const processed = await MessageUtil.processMessage(originalContext);
            processedMessage = processed.content;
            messageType = processed.type;
            metadata = processed.metadata;
        }

        const payload = {
            from,
            message: processedMessage,
            messageType,
            metadata,
            timestamp: new Date().toISOString()
        };

        try {
            console.log('📤 [N8N] Enviando a:', this.webhookUrl);
            console.log('📦 [N8N] Payload:', JSON.stringify(payload, null, 2));

            const response = await axios({
                method: 'POST',
                url: this.webhookUrl,
                data: payload,
                headers: {
                    'Content-Type': 'application/json'
                },
                timeout: 5000
            });

            console.log('✅ [N8N] Respuesta recibida');
            return response.data;

        } catch (error) {
            console.error('❌ [N8N] Error:', {
                message: error.message,
                response: error.response?.data,
                status: error.response?.status
            });
            throw new Error(`Error enviando a n8n: ${error.message}`);
        }
    }
}

module.exports = new N8NService();
